{% extends "base.html" %}

{% block content %}
<header class="mb-2">
    <h1>Settings</h1>
    <p class="text-muted">Manage your account and connections</p>
</header>

<div style="max-width: 600px;">
    <!-- SimpleFin Status -->
    <div class="card">
        <h2>Bank Connection</h2>
        <div id="status-box" class="flex align-center mt-2 mb-2"
            style="padding: 1rem; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);">
            <div id="status-dot" style="width: 10px; height: 10px; border-radius: 50%; background: #666;"></div>
            <span id="status-text">Checking...</span>
        </div>

        <div id="connect-form" style="display: none;">
            <p class="text-muted mb-2">Enter your SimpleFin Access Key. It will be encrypted securely.</p>
            <div class="form-group">
                <input type="password" id="simplefin-key" placeholder="Paste Access Key or Setup Token">
            </div>
            <button class="btn btn-primary" onclick="connect()">Connect</button>
        </div>

        <div id="manage-form" style="display: none;">
            <div class="flex">
                <button class="btn btn-primary" id="sync-btn" onclick="syncBank()">Sync Now</button>
                <button class="btn btn-danger" onclick="disconnect()">Disconnect</button>
            </div>
            <div id="sync-result" class="mt-2" style="display: none;"></div>
        </div>
        <!-- Category Management -->
        <div class="card mt-2">
            <h2>Manage Categories</h2>
            <p class="text-muted mb-2">
                Edit or remove your categories. Renaming will update all historic transactions.
            </p>

            <!-- Category Dropdown + Actions -->
            <div class="flex align-center mb-2"
                style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                <div class="form-group" style="flex-grow: 1; margin-bottom: 0;">
                    <select id="manage-category-select" onchange="updateManageButtons()" class="w-100"></select>
                </div>
                <button class="btn btn-secondary" onclick="renameCurrent()">Rename</button>
                <button class="btn btn-danger" id="delete-current-btn" onclick="deleteCurrent()">Delete</button>
            </div>

            <!-- Add Category -->
            <div class="flex mt-2" style="padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <div class="form-group" style="flex-grow: 1; margin-bottom: 0;">
                    <input type="text" id="new-cat-name" placeholder="New category name (e.g. Travel)">
                </div>
                <button class="btn btn-primary" onclick="addCategory()">Add New</button>
            </div>
        </div>
    </div>

    <!-- Rename Modal (simple prompt replacement for now or custom) -->
    {% endblock %}

    {% block scripts %}
    <script>
        let categoriesExtended = [];

        async function checkStatus() {
            const res = await fetchAuth('/api/simplefin/status');
            const data = await res.json();

            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');

            if (data.connected) {
                dot.style.background = '#00ff88';
                text.textContent = 'Connected to SimpleFin';
                document.getElementById('connect-form').style.display = 'none';
                document.getElementById('manage-form').style.display = 'block';
            } else {
                dot.style.background = '#ff6b6b';
                text.textContent = 'Not connected';
                document.getElementById('connect-form').style.display = 'block';
                document.getElementById('manage-form').style.display = 'none';
            }
        }

        async function loadCategories() {
            const res = await fetchAuth('/api/categories/extended');
            if (res.ok) {
                categoriesExtended = await res.json();
                renderCategories();
            }
        }

        function renderCategories() {
            const select = document.getElementById('manage-category-select');
            if (!select) return;

            if (categoriesExtended.length === 0) {
                select.innerHTML = `<option value="">No categories found</option>`;
                return;
            }

            select.innerHTML = categoriesExtended.map(c => `
            <option value="${c.id}" data-name="${c.name.replace(/"/g, '&quot;')}">${c.name}</option>
        `).join('');

            updateManageButtons();
        }

        function updateManageButtons() {
            const select = document.getElementById('manage-category-select');
            const deleteBtn = document.getElementById('delete-current-btn');
            if (!select || !deleteBtn) return;

            const selectedOption = select.options[select.selectedIndex];
            if (!selectedOption) return;

            const name = selectedOption.getAttribute('data-name');
            deleteBtn.disabled = (name === 'Other');
            deleteBtn.style.opacity = (name === 'Other') ? '0.5' : '1';
        }

        function renameCurrent() {
            const select = document.getElementById('manage-category-select');
            const selectedOption = select.options[select.selectedIndex];
            if (!selectedOption) return;

            const id = selectedOption.value;
            const name = selectedOption.getAttribute('data-name');
            renameCategory(id, name);
        }

        function deleteCurrent() {
            const select = document.getElementById('manage-category-select');
            const selectedOption = select.options[select.selectedIndex];
            if (!selectedOption) return;

            const id = selectedOption.value;
            const name = selectedOption.getAttribute('data-name');
            if (name === 'Other') return;
            deleteCategory(id);
        }

        async function addCategory() {
            const input = document.getElementById('new-cat-name');
            const name = input.value.trim();
            if (!name) return;

            const res = await fetchAuth('/api/categories', {
                method: 'POST',
                body: JSON.stringify({ name })
            });

            if (res.ok) {
                input.value = '';
                loadCategories();
            } else {
                const data = await res.json();
                alert(data.message || 'Error adding category');
            }
        }

        async function renameCategory(id, oldName) {
            const newName = prompt(`Enter new name for "${oldName}":`, oldName);
            if (!newName || newName.trim() === '' || newName === oldName) return;

            const res = await fetchAuth(`/api/categories/${id}`, {
                method: 'PUT',
                body: JSON.stringify({ name: newName.trim() })
            });

            if (res.ok) {
                loadCategories();
            } else {
                const data = await res.json();
                alert(data.message || 'Error renaming category');
            }
        }

        async function deleteCategory(id) {
            if (!confirm('Are you sure? This will move all transactions in this category to "Other".')) return;

            const res = await fetchAuth(`/api/categories/${id}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                loadCategories();
            } else {
                const data = await res.json();
                alert(data.message || 'Error deleting category');
            }
        }

        async function connect() {
            const key = document.getElementById('simplefin-key').value;
            if (!key) { alert('Please enter key'); return; }

            const res = await fetchAuth('/api/simplefin/save-key', {
                method: 'POST',
                body: JSON.stringify({ access_key: key })
            });

            if (res.ok) {
                alert('Connected!');
                checkStatus();
            } else {
                const data = await res.json();
                alert('Failed: ' + (data.message || 'Unknown error'));
            }
        }

        async function disconnect() {
            if (!confirm('Are you sure?')) return;
            await fetchAuth('/api/simplefin/disconnect', { method: 'POST' });
            checkStatus();
        }

        async function syncBank() {
            const btn = document.getElementById('sync-btn');
            const resDiv = document.getElementById('sync-result');

            btn.disabled = true;
            btn.textContent = '⏳ Syncing...';
            resDiv.style.display = 'none';

            try {
                const res = await fetchAuth('/api/simplefin/sync', { method: 'POST' });
                const data = await res.json();

                resDiv.style.display = 'block';
                if (res.ok) {
                    resDiv.innerHTML = `
                    <div style="color: #00ff88; background: rgba(0,255,136,0.1); padding: 1rem; border-radius: 8px;">
                        ✓ Sync Complete. Found ${data.accounts.length} accounts.<br>
                        ${data.new_transactions ? `+ ${data.new_transactions} new transactions.` : ''}
                    </div>
                `;
                } else {
                    resDiv.innerHTML = `<div style="color: #ff6b6b;">Error: ${data.message}</div>`;
                }
            } catch (e) {
                resDiv.style.display = 'block';
                resDiv.innerHTML = `<div style="color: #ff6b6b;">Network Error</div>`;
            }

            btn.disabled = false;
            btn.textContent = 'Sync Now';
        }

        checkStatus();
        loadCategories();
    </script>
    {% endblock %}